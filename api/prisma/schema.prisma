generator client {
  provider = "prisma-client-js"
  // binaryTargets = ["debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Status {
  ENABLE  @map("habilitado")
  DISABLE @map("deshabilitado")

  @@map("estado")
}

enum StatusConnection {
  ONLINE  @map("en linea")
  OFFLINE @map("desconectado")
}

enum LevelPermission {
  CREATE @map("escritura")
  READ   @map("lectura")
  UPDATE @map("actualización")
  DELETE @map("eliminación")

  @@map("tipo_de_permiso")
}

enum Resource {
  USER         @map("usuario")
  PROPERTY     @map("predio")
  BENEFICIARY  @map("beneficiario")
  CITY         @map("departamento")
  PROVINCE     @map("provincia")
  MUNICIPALITY @map("municipio")

  USER_PERMISSION @map("permiso_de_usuario")
  CLASIFICATION   @map("clasificación")
  ACTIVITY        @map("actividad")
  OBSERVATION     @map("observación")
  PERMISSION      @map("permiso")
  USERTYPE        @map("tipo_de_usuario")

  TYPE          @map("tipo")
  SUB_DIRECTORY @map("sub_carpeta")

  @@map("recurso")
}

enum ObservationType {
  TECHNICAL @map("tecnico")
  LEGAL     @map("juridico")
  STANDARD  @map("estandar")

  @@map("tipo_de_observación")
}

model User {
  id             String           @id @default(uuid())
  names          String?          @map("nombre") @db.VarChar(30)
  firstLastName  String?          @map("apellido_paterno") @db.VarChar(50)
  secondLastName String?          @map("apellido_materno") @db.VarChar(50)
  username       String           @unique @map("nombre_de_usuario") @db.VarChar(20)
  password       String           @map("contraseña") @db.MediumText
  typeId         String           @map("tipo_id")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  token          String?          @db.MediumText
  permissions    UserPermission[]
  type           UserType         @relation(fields: [typeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  status         Status           @default(ENABLE) @map("estado")
  connection     StatusConnection @default(OFFLINE) @map("estado_de_conexion")
  records        Record[]
  property       Property?        @relation(fields: [propertyId], references: [id])
  propertyId     String?

  @@map("usuario")
}

model DeletedUser {
  id             String   @id @default(uuid())
  names          String?  @map("nombre") @db.VarChar(30)
  firstLastName  String?  @map("apellido_paterno") @db.VarChar(50)
  secondLastName String?  @map("apellido_materno") @db.VarChar(50)
  username       String   @unique @map("nombre_de_usuario") @db.VarChar(20)
  typeId         String?  @map("tipo_id")
  deletedAt      DateTime @default(now())
  reason         String? // Puedes agregar un campo para registrar la razón de la eliminación.
  status         Status   @default(ENABLE) @map("estado")

  @@map("usuario_eliminado")
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @map("nombre")
  level       LevelPermission  @map("nivel_de_acceso")
  resource    Resource         @map("recurso")
  description String           @map("descripcion")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  users       UserPermission[]
  status      Status           @default(ENABLE) @map("estado")

  @@unique([resource, level])
  @@index([resource, level])
  @@map("permiso")
}

model UserPermission {
  id           String     @id @default(uuid())
  status       Status     @default(ENABLE) @map("estado")
  userId       String     @map("usuario_id")
  permissionId String     @map("permiso_id")
  expires      Expires?
  user         User       @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  // UserDeleted   UserDeleted? @relation(fields: [userDeletedId], references: [id])
  // userDeletedId String?

  @@unique([userId, permissionId])
  @@map("permiso_de_usuario")
}

model Expires {
  id               String         @id @default(uuid())
  userPermissionId String         @unique @map("expira")
  userPermission   UserPermission @relation(fields: [userPermissionId], references: [id], map: "expiracion")

  @@map("expiracion")
}

model UserType {
  id    String @id @default(uuid())
  name  String @unique @map("nombre")
  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tipo_de_usuario")
}

model Property {
  id                   String        @id @default(uuid())
  name                 String        @map("nombre") @db.MediumText
  area                 String        @map("superficie")
  expertiseOfArea      String        @map("superficie_de_pericia") // evaluar varias areas
  plots                Int           @default(0) @map("parcelas")
  bodies               Int           @default(0) @map("cuerpos")
  sheets               Int           @default(0) @map("fojas")
  code                 String?       @unique @default("Sin codigo definido") @map("codigo") @db.VarChar(128) // es nullable pero tambie es unico
  codeOfSearch         String        @default("Sin codigo de busqueda definido") @map("codigo_de_busqueda") @db.VarChar(128)
  agrupationIdentifier String        @default("Sin Id de agrupación definido") @map("id_de_agrupacion_social") @db.VarChar(64)
  secondState          String        @default("Sin estado definido") @map("estado_2") @db.VarChar(128)
  polygone             String        @map("poligono") @db.VarChar(32) // OJO
  observations         Observation[]
  beneficiaries        Beneficiary[]
  users                User[]

  cityId         String       @unique() @map("departamento_id")
  provinceId     String       @unique() @map("provincia_id")
  municipalityId String       @unique() @map("municipio_id")
  city           City         @relation(fields: [cityId], references: [id])
  province       Province     @relation(fields: [provinceId], references: [id])
  municipality   Municipality @relation(fields: [municipalityId], references: [id])
  activity       Activity?    @relation(fields: [activityId], references: [id])
  activityId     String?
  type           Type?        @relation(fields: [typeId], references: [id])
  typeId         String?

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  clasification     Clasification?   @relation(fields: [clasificationId], references: [id])
  clasificationId   String?
  state             State?           @relation(fields: [stateId], references: [id])
  stateId           String?
  groupedState      GroupedState?    @relation(fields: [groupedStateId], references: [id])
  groupedStateId    String?
  reference         Reference?       @relation(fields: [referenceId], references: [id])
  referenceId       String?
  responsibleUnit   ResponsibleUnit? @relation(fields: [responsibleUnitId], references: [id])
  responsibleUnitId String?
  subDirectory      SubDirectory?    @relation(fields: [subDirectoryId], references: [id])
  subDirectoryId    String?

  @@map("predio")
}

model Observation {
  id          String          @id @default(uuid())
  observation String          @map("observacion") @db.MediumText
  type        ObservationType @default(STANDARD) @map("tipo")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  propertyId  String          @map("predio_id")
  property    Property        @relation(fields: [propertyId], references: [id])

  @@map("observacion")
}

model Beneficiary {
  id         String     @id @default(uuid())
  name       String     @unique @map("nombre") @db.VarChar(256)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  properties Property[]

  @@map("beneficiario")
}

model Reference {
  id         String     @id @default(uuid())
  name       String     @unique @map("nombre") @db.VarChar(64)
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@map("referencia")
}

model State {
  id         String     @id @default(uuid())
  name       String     @unique @map("nombre")
  order      String     @map("orden") @db.VarChar(16)
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  stage      Stage?     @relation(fields: [stageId], references: [id])
  stageId    String?

  @@map("estado")
}

model Stage {
  id        String   @id @default(uuid())
  name      String   @unique() @map("nombre") @db.VarChar(32)
  states    State[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("etapa")
}

model SubDirectory {
  id         String     @id @default(uuid())
  name       String     @unique() @map("nombre") @db.VarChar(128)
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@map("sub_carpeta")
}

model Type {
  id   String @id @default(uuid())
  name String @unique @map("nombre") @db.VarChar(64)

  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@map("tipo")
}

model Activity {
  id         String     @id @default(uuid())
  name       String     @unique @map("nombre") @db.VarChar(64)
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@map("actividad")
}

model Clasification {
  id         String     @id @default(uuid())
  name       String     @unique @map("nombre") @db.VarChar(64)
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@map("clasificacion")
}

model ResponsibleUnit {
  id         String     @id @default(uuid())
  name       String     @unique @map("nombre") @db.VarChar(64)
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@map("unidad_responsable")
}

model GroupedState {
  id         String     @id @default(uuid())
  name       String     @unique @map("nombre") @db.VarChar(128)
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@map("estado_agrupado")
}

model City {
  id         String     @id @default(uuid())
  name       String     @unique @map("nombre") @db.VarChar(32)
  provinces  Province[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  properties Property[]

  @@map("departamento")
}

model Province {
  id             String         @id @default(uuid())
  code           String         @unique @map("codigo") @db.VarChar(32)
  name           String         @unique @map("nombre") @db.VarChar(32)
  cityId         String         @map("departamento_id")
  city           City           @relation(fields: [cityId], references: [id])
  municipalities Municipality[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  properties     Property[]

  @@map("provincia")
}

model Municipality {
  id         String     @id @default(uuid())
  name       String     @unique @map("nombre") @db.VarChar(32)
  provinceId String     @map("provincia_id")
  province   Province   @relation(fields: [provinceId], references: [id])
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  Property   Property[]

  @@map("municipio")
}

model Record {
  id          String          @id @default(uuid())
  userId      String          @map("usuario_id")
  description String          @map("descripcion") @db.MediumText
  user        User            @relation(fields: [userId], references: [id])
  operation   String          @map("operacion")
  action      LevelPermission @map("tipo_de_action")
  resource    Resource        @map("recurso")
  result      Json            @map("resultado")
  ip          String          @map("direccion_ip")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("historial")
}
